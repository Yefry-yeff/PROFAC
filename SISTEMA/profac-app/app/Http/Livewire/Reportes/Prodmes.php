<?php

namespace App\Http\Livewire\Reportes;

use Livewire\Component;
use Illuminate\Database\QueryException;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\Request;
use DataTables;
use Auth;
use Validator;
use PDF;
use Luecano\NumeroALetras\NumeroALetras;

use App\Models\ModelFactura;
use App\Models\ModelCAI;
use App\Models\ModelRecibirBodega;
use App\Models\ModelVentaProducto;
use App\Models\ModelLogTranslados;
use App\Models\ModelParametro;
use App\Models\ModelLista;
use App\Models\ModelCliente;
use App\Models\logCredito;
use App\Models\User;

class Prodmes extends Component
{
    public function render()
    {
        return view('livewire.reportes.prodmes');
    }

    public function consultaComision($fecha_inicio, $fecha_final){
        try {



            $consulta = DB::SELECT("

                select
                date_format(A.created_at, '%d-%m-%Y') as 'FECHA',
                date_format(A.fecha_vencimiento, '%d-%m-%Y') as 'FECHA VENCIMIENTO',
                UPPER(tpv.descripcion) as 'CRÉDITO/CONTADO',
                (
                    CASE A.estado_factura_id WHEN '1' THEN 'CLIENTE A' WHEN '2' THEN 'CLIENTE B' END
                ) AS 'TIPO CLIENTE (AoB)',
                UPPER(us.name) as 'VENDEDOR',
                (
                    RIGHT(A.cai, 5)
                ) as 'FACTURA',
                cli.nombre as 'CLIENTE',
                C.id as 'CÓDIGO',
                C.nombre as 'PRODUCTO',
                B.precio_unidad as 'PRECIO PRODUCTO',
                B.numero_unidades_resta_inventario as 'CANTIDAD',
                FORMAT(B.sub_total_s, 2) as 'SUB TOTAL PRODUCTO',
                FORMAT(B.isv_s, 2) as 'ISV',
                B.total_s as 'TOTAL PRODUCTO',
                FORMAT(
                    (A.total / 1.15),
                    2
                ) as 'SUB TOTAL FACTURA',
                FORMAT(A.total, 2) as 'TOTAL FACTURA',
                FORMAT(
                    (
                    (A.total / 1.15)- B.sub_total_s
                    ),
                    2
                ) as 'SUB TOTAL DIFERENCIA',
                (
                    CASE tpv.descripcion WHEN 'CREDITO' THEN 'N/A' WHEN 'CONTADO' THEN FORMAT(
                    (B.sub_total_s * 0.0175),
                    2
                    ) END
                ) AS 'CONTADO 1.75%',
                (
                    CASE tpv.descripcion WHEN 'CREDITO' THEN FORMAT(
                    (B.sub_total_s * 0.0150),
                    2
                    ) WHEN 'CONTADO' THEN 'N/A' END
                ) AS 'CREDITO 1.5%',
                (
                    IF(
                    (
                        select
                        count(*)
                        from
                        venta_has_producto
                        where
                        factura_id = A.id
                        and producto_id not in (
                            1006, 1035, 1940, 1942, 1943, 1944, 1945,
                            1946, 1947, 1948, 1949, 1950, 1951,
                            1952, 1953, 1954, 1955, 1956, 1957,
                            1958, 1959, 1960, 1961, 1962, 1963,
                            1964, 1965, 2029, 2030, 2223, 2244,
                            2300, 2301, 2396, 2397, 2404, 2474,
                            2527, 2547, 2699, 2723, 2884, 2901
                        )
                    ) = 0,
                    'N/A',
                    FORMAT(
                        (
                        (A.total - B.sub_total_s)* 0.02
                        ),
                        2
                    )
                    )
                ) AS 'COMISION OTROS PRUEBA'
                from
                factura A
                inner join venta_has_producto B on A.id = B.factura_id
                inner join producto C on B.producto_id = C.id
                inner join unidad_medida_venta D on B.unidad_medida_venta_id = D.id
                inner join unidad_medida E on E.id = D.unidad_medida_id
                inner join sub_categoria sc on sc.id = C.sub_categoria_id
                inner join categoria_producto cp on cp.id = sc.categoria_producto_id
                inner join cliente cli on cli.id = A.cliente_id
                inner join tipo_pago_venta tpv on tpv.id = A.tipo_pago_id
                inner join users us on us.id = A.vendedor
                where
                A.estado_venta_id = 1
                and C.id in (
4863,
4864,
4862,
4861,
4860,
4859,
4858,
4857,
4856,
4855,
4854,
4853,
4852,
4851,
4850,
4849,
4848,
4847,
4846,
4845,
4844,
4843,
4842,
4841,
4840,
4839,
4838,
4837,
4836,
4835,
4586,
4537,
4536,
4535,
4534,
4533,
4532,
4531,
4530,
4316,
4315,
4314,
4313,
4312,
4311,
4310,
4309,
4308,
4307,
4227,
3908,
3706,
3705,
3676,
3675,
3638,
3634,
3633,
3632,
3631,
3630,
3627,
3562,
3507,
3504,
3308,
3263,
3262,
3260,
3259,
3257,
3256,
3254,
3253,
3199,
3196,
3192,
3189,
3185,
3184,
3183,
3179,
2936,
2935,
2928,
2927,
2911,
2906,
2905,
2904,
2903,
2735,
2734,
2733,
2732,
2731,
2730,
2685,
2681,
2601,
2463,
2462,
2461,
2460,
2459,
2458,
2455,
2454,
2420,
2419,
2413,
2408,
2407,
2384,
2383,
2370,
2369,
2368,
2367,
2366,
2365,
2364,
2349,
2285,
2267,
2266,
1437,
1436,
1435,
1434,
1432,
1431,
1429,
1428,
1427,
1426,
1425,
1424,
1423,
1422,
1421,
1420,
1419,
1418,
1417,
1416,
1415,
1414,
1413,
1412,
1411,
1410,
1409,
1408,
1407,
1406,
1405,
1404,
1403,
1402,
1401,
1400,
1399,
1398,
1397,
1396,
1395,
1394,
1393,
1392,
1391,
1390,
1389,
1388,
1387,
1386,
1385,
1384,
1383,
1382,
1381,
1380,
1379,
1378,
1377,
1376,
1375,
1374,
1373,
1372,
1371,
1370,
1369,
1368,
1367,
1366,
1365,
1364,
1363,
1362,
1361,
1360,
1359,
1358,
1357,
1356,
1355,
1354,
1353,
1352,
1351,
1350,
1349,
1348,
1347,
1346,
1345,
1344,
1343,
1342,
1341,
1340,
1339,
1338,
1337,
1336,
1335,
1334,
1333,
1332,
1331,
1330,
1329,
1328,
1327,
1326,
1325,
1324,
1323,
1322,
1320,
1319,
1318,
1317,
1316,
1315,
1314,
1313,
1312,
1311,
1310,
1309,
1308,
1307,
1306,
1305,
1304,
1303,
1302,
1301,
1300,
1299,
1298,
1297,
1296,
1295,
1294,
1293,
1292,
1008,
1007,
1433,
2265,
2930,
3060,
3062,
4291,
4290,
1134,
4359,
4358,
4357,
4355,
4354,
4346,
4030,
3578,
3577,
3565,
3417,
2901,
2884,
2723,
2699,
2547,
2527,
2474,
2404,
2397,
2396,
2300,
2244,
1963,
1962,
1961,
1960,
1959,
1958,
1957,
1956,
1955,
1954,
1953,
1952,
1951,
1950,
1949,
1948,
1947,
1946,
1945,
1944,
1006,
4511,
4510,
4274,
4272,
4270,
4226,
4222,
4221,
4210,
4101,
4099,
4098,
4097,
4092,
4091,
4090,
4089,
4088,
4087,
4084,
4081,
4074,
4073,
4072,
4071,
4070,
4068,
4035,
3943,
3942,
3941,
3940,
3939,
3938,
3937,
3936,
3935,
3934,
3933,
3932,
3931,
3930,
3929,
3928,
3927,
3926,
3925,
3924,
3473,
3421,
3126,
3125,
3124,
3122,
3073,
2541,
2509,
2508,
2507,
2506,
2505,
2504,
2503,
2502,
2501,
2500,
2499,
2498,
2497,
2496,
2495,
2494,
2493,
2492,
2491,
2490,
2410,
2392,
2391,
2390,
2389,
2353,
2303,
2302,
2271,
2230,
2229,
2228,
1268,
1267,
1266,
1265,
1264,
1263,
1262,
1261,
1260,
1258,
1257,
1256,
1255,
1254,
1253,
1252,
1251,
1250,
1249,
1248,
1247,
1246,
1245,
1244,
1243,
1242,
1241,
1240,
1239,
1238,
1237,
1236,
1235,
1234,
1233,
1232,
1230,
1229,
1228,
1227,
1226,
1225,
1224,
1223,
1222,
1221,
1220,
1219,
1218,
1217,
2947,
4405,
4404,
4403,
3458,
3414,
3173,
3172,
3171,
3170,
3169,
3168,
3167,
3166,
3165,
3164,
3163,
3162,
3161,
3160,
3159,
3158,
3157,
3156,
3155,
3154,
3153,
3152,
3151,
3150,
3149,
3148,
3147,
3146,
2260,
3478,
2598,
2596,
2595,
2594,
2593,
2592,
2591,
2590,
2587,
2586,
2583,
2580,
2579,
2578,
2577,
2571,
2570,
2569,
2372,
2371,
1195,
1194,
1192,
1190,
1189,
1188,
1187,
3408,
2602,
2224,
1559,
1558,
1557,
1556,
1555,
1554,
1553,
1552,
1551,
1940,
1943,
3907,
4022,
4085,
4514,
2030,
2029,
1035,5009,5008,5007,5006,5005,5004,5003,5002,5001,5000,4999,4998,4997,4996,4979,4977,4976,4975,4866,4605,4159,4129,4096,4095,4094,4034,3689,3688,3406,2899,2898,2897,2896,2895,2894,2893,2887,2729,2701,2698,2697,2696,2695,2694,2693,2692,2691,2690,2689,2688,2683,2682,2680,2679,2678,2677,2675,2672,2671,2670,2669,2668,2667,2401,2275,2274,2243,1703,1702,1701,1700,1699,1698,1697,1696,1695,1694,1693,1692,1691,1690,1689,1688,1430,4512,4305,4277,4158,4126,4125,4124,3065,3063,2967,4944,2301,2223,1024,4962,4937,4277,4273,3567,2946,1968,1200,1199,1132,1131,1130,1004,4982,4981,4980,5105,5104,5103,5102,5101,5100,4972
,4938,1961,1004
,1007
,1008
,1018
,1024
,1035
,1130
,1131
,1132
,1187
,1188
,1189
,1190
,1192
,1194
,1195
,1217
,1218
,1219
,1220
,1221
,1222
,1223
,1224
,1225
,1226
,1227
,1228
,1229
,1230
,1231
,1232
,1233
,1234
,1235
,1236
,1237
,1238
,1239
,1240
,1241
,1242
,1243
,1244
,1245
,1246
,1247
,1248
,1249
,1250
,1251
,1252
,1253
,1254
,1255
,1256
,1257
,1258
,1259
,1260
,1261
,1262
,1263
,1264
,1265
,1266
,1267
,1268
,1292
,1293
,1294
,1295
,1296
,1297
,1298
,1299
,1300
,1301
,1302
,1303
,1304
,1305
,1306
,1307
,1308
,1309
,1310
,1311
,1312
,1313
,1314
,1315
,1316
,1317
,1318
,1319
,1320
,1321
,1322
,1323
,1324
,1325
,1326
,1327
,1328
,1329
,1330
,1331
,1332
,1333
,1334
,1335
,1336
,1337
,1338
,1339
,1340
,1341
,1342
,1343
,1344
,1345
,1346
,1347
,1348
,1349
,1350
,1351
,1352
,1353
,1354
,1355
,1356
,1357
,1358
,1359
,1360
,1361
,1362
,1363
,1364
,1365
,1366
,1367
,1368
,1369
,1370
,1371
,1372
,1373
,1374
,1375
,1376
,1377
,1378
,1379
,1380
,1381
,1382
,1383
,1384
,1385
,1386
,1387
,1388
,1389
,1390
,1391
,1392
,1393
,1394
,1395
,1396
,1397
,1398
,1399
,1400
,1401
,1402
,1403
,1404
,1405
,1406
,1407
,1408
,1409
,1410
,1411
,1412
,1413
,1414
,1415
,1416
,1417
,1418
,1419
,1420
,1421
,1422
,1423
,1424
,1425
,1426
,1427
,1428
,1429
,1430
,1431
,1432
,1433
,1434
,1435
,1436
,1437
,1530
,1531
,1534
,1539
,1542
,1546
,1547
,1548
,1549
,1551
,1552
,1553
,1554
,1555
,1556
,1557
,1558
,1559
,1562
,1563
,1564
,1565
,1688
,1689
,1690
,1691
,1692
,1693
,1694
,1695
,1696
,1697
,1698
,1699
,1700
,1701
,1702
,1703
,1940
,1943
,1944
,1945
,1946
,1947
,1948
,1949
,1950
,1951
,1952
,1953
,1954
,1955
,1956
,1957
,1958
,1959
,1960
,1961
,1962
,1963
,2029
,2030
,2223
,2224
,2228
,2229
,2230
,2243
,2244
,2260
,2265
,2266
,2267
,2271
,2285
,2300
,2301
,2302
,2303
,2349
,2353
,2364
,2365
,2366
,2367
,2368
,2369
,2370
,2371
,2372
,2383
,2384
,2389
,2390
,2391
,2392
,2396
,2397
,2401
,2404
,2407
,2408
,2409
,2410
,2413
,2419
,2420
,2452
,2454
,2455
,2458
,2459
,2460
,2461
,2462
,2463
,2464
,2474
,2490
,2491
,2492
,2493
,2494
,2495
,2496
,2497
,2498
,2499
,2500
,2501
,2502
,2503
,2504
,2505
,2506
,2507
,2508
,2509
,2527
,2541
,2547
,2569
,2570
,2571
,2577
,2578
,2579
,2580
,2583
,2585
,2586
,2587
,2590
,2591
,2592
,2593
,2594
,2595
,2596
,2598
,2601
,2602
,2681
,2682
,2683
,2685
,2699
,2723
,2729
,2730
,2731
,2732
,2733
,2734
,2735
,2884
,2893
,2894
,2895
,2897
,2898
,2901
,2903
,2904
,2905
,2906
,2911
,2927
,2928
,2930
,2935
,2936
,2937
,2946
,2947
,2967
,3060
,3062
,3063
,3065
,3073
,3122
,3124
,3125
,3126
,3146
,3147
,3148
,3149
,3150
,3151
,3152
,3153
,3154
,3155
,3156
,3157
,3158
,3159
,3160
,3161
,3162
,3163
,3164
,3165
,3166
,3167
,3168
,3169
,3170
,3171
,3172
,3173
,3179
,3183
,3184
,3185
,3189
,3192
,3196
,3199
,3253
,3254
,3256
,3257
,3259
,3260
,3262
,3263
,3308
,3408
,3414
,3417
,3421
,3458
,3473
,3478
,3504
,3507
,3562
,3565
,3577
,3578
,3627
,3630
,3631
,3632
,3633
,3634
,3638
,3675
,3676
,3688
,3689
,3705
,3706
,3907
,3908
,3924
,3925
,3926
,3927
,3928
,3929
,3930
,3931
,3932
,3933
,3934
,3935
,3936
,3937
,3938
,3939
,3940
,3941
,3942
,3943
,4022
,4030
,4035
,4068
,4070
,4071
,4072
,4073
,4074
,4081
,4084
,4085
,4087
,4088
,4089
,4090
,4091
,4092
,4095
,4097
,4098
,4099
,4101
,4124
,4125
,4126
,4129
,4158
,4159
,4210
,4221
,4222
,4226
,4227
,4270
,4272
,4273
,4274
,4277
,4290
,4291
,4305
,4307
,4308
,4309
,4310
,4311
,4312
,4313
,4314
,4315
,4316
,4346
,4354
,4355
,4357
,4358
,4359
,4403
,4404
,4405
,4510
,4511
,4512
,4514
,4530
,4531
,4532
,4533
,4534
,4535
,4536
,4537
,4586
,4605
,4835
,4836
,4837
,4838
,4839
,4840
,4841
,4842
,4843
,4844
,4845
,4846
,4847
,4848
,4849
,4850
,4851
,4852
,4853
,4854
,4855
,4856
,4857
,4858
,4859
,4860
,4861
,4862
,4863
,4937
,4938
,4944
,4962
,4972
,4975
,4976
,4977
,4979
,4980
,4981
,4982
,4996
,4997
,4998
,4999
,5000
,5001
,5002
,5003
,5004
,5005
,5006
,5007
,5008
,5009
,5100
,5101
,5102
,5103
,5104
,5105
,5168
,5229
,5232
,5233
,5287
,5291
,5292
,5293
,5294
,5295
,5314
,5344
,5345
,5374
,5375
,5376
,5490
,5493
,5499
,5500
,5505
,5506
,5507
,5515
,5523
,5527
,5544
,5627
,5639
,5640
,5709
,5716
,5724
,5781
,5783
,5801
,5802
,5803
,5804
,5805
,5806
,5807
,5808
,5809
,5810
,5811
,5812
,5813
,5814
,5815
,5816
,5817
,5818
,5819
,5820
,5821
,5822
,5823
,5824
,5826
,5827
,5828
,5829
,5830
,5832
,5848
,5854
,5855
,5862
,5881
,5906
,5909
,5910
,5920
,5923
,5926
,5928
,5931
,5934
,5937
,5941
,5945
,5948
,5950
,5953
,5955
,5958
,5960
,5962
,5964
,5966
,5967
,5970
,5972
,5974
,5975
,5976
,5979
,5981
,5984
,5985
,5988
,6053
,6441
,6444
,6447
,6463
,6466
,6474
,6480
,6576
,6591
,6678
,6817
,6843
,6847
,6849
,6851
,6854
,6855
,6857
,6859
,6860
,6861
,6862
,6863
,6865
,6867
,6933
,6943
,6944
,6945
,6946
,6948
,6951
,6952
,6953
,6954
,6956
,6957
,6958
,6960
,6961
,6962
,6963
,6964
,6965
,6966
,6967
,6968
,6970
,6971
,6973
,6974
,6977
,6978
,6980
,6981
,7001
,7002
,7003
,7004
,7007
,7009
,7010
,7098
,7130
,7131
,7132
,7133
,7135
,7137
,7139
,7143
,7214
,7217
,7312
,7315
,7319
,7329
,7331
,7333
,7335
,7337
,7352
,7355
,7357
,7360
,7362
,7365
,7367
,7370
,7372
,7373
,7374
,7376
,7378
,7379
,7381
,7383
,7385
,7404
,7412
,7415
,7419
,7424
,7430
,7572
,7610
,7611
,7617
,7618
,7619
,7620
,7621
,7622
,7623
,7624
,7625
,7626
,7627
,7628
,7629
,7630
,7631
,7632
,7633
,7634
,7635
,7636
,7637
,7638
,7639
,7640
,7643
,7644
,7645
,7908
                )
                and DATE(A.created_at) >= DATE_FORMAT('".$fecha_inicio."', '%Y-%m-%d')
                and DATE(A.created_at) <= DATE_FORMAT('".$fecha_final."', '%Y-%m-%d')
                order by
                A.created_at DESC
            ");





            return Datatables::of($consulta)
            ->rawColumns([])
            ->make(true);

        } catch (QueryException $e) {
            return response()->json([
                'message' => 'Ha ocurrido un error al listar el reporte solicitado.',
                'errorTh' => $e,
            ], 402);

        }

    }
}
